{"version":3,"file":"savings-BnhwmOt9.js","sources":["../../src/stores/savings.ts"],"sourcesContent":["import { defineStore } from 'pinia'\r\nimport { ref, computed } from 'vue'\r\nimport { formatUnits, parseUnits } from 'ethers'\r\nimport { useWalletStore } from './wallet'\r\nimport { useAppStore } from './app'\r\nimport { contractService } from '@/services/contracts'\r\nimport BigNumber from 'bignumber.js'\r\n\r\nexport const useSavingsStore = defineStore('savings', () => {\r\n  // State\r\n  const userBalance = ref('0') // sWRMB balance\r\n  const wrmbBalance = ref('0') // WRMB balance\r\n  const totalAssets = ref('0') // Total assets in vault\r\n  const currentNAV = ref('1.0') // Current NAV\r\n  const currentPrice = ref('0.14') // Current WRMB price in USD\r\n  const totalSupply = ref('0') // Total sWRMB supply\r\n  const totalMMFSupply = ref('0') // Total MMF supply\r\n  const apy = ref('0') // Annual percentage yield\r\n  const dynamicAPY = ref('0') // Dynamic APY\r\n  const dynamicWRMB = ref('0') // Dynamic WRMB\r\n  const userAssetValue = ref('0') // User's asset value in maxWithdraw \r\n  const userIncrementAmount = ref('0') // User's increment amount\r\n  const isLoading = ref(false)\r\n  const lastUpdateTime = ref(0)\r\n  const historicalNAV = ref<Array<{ timestamp: number, nav: number }>>([]) // Historical NAV data for APY calculation\r\n\r\n  // Form state\r\n  const depositAmount = ref('')\r\n  const withdrawAmount = ref('')\r\n  const isDepositing = ref(false)\r\n  const isWithdrawing = ref(false)\r\n\r\n  // Getters\r\n  const userBalanceFormatted = computed(() => {\r\n    return new BigNumber(formatUnits(userBalance.value, 18)).toFixed(6)\r\n  })\r\n\r\n  const wrmbBalanceFormatted = computed(() => {\r\n    return new BigNumber(formatUnits(wrmbBalance.value, 18)).toFixed(6)\r\n  })\r\n\r\n  const totalAssetsFormatted = computed(() => {\r\n    return new BigNumber(totalAssets.value).toFixed(2)\r\n  })\r\n\r\n  const userSharePercentage = computed(() => {\r\n    if (totalSupply.value === '0' || userBalance.value === '0') return '0'\r\n    return new BigNumber(userBalance.value)\r\n      .dividedBy(totalSupply.value)\r\n      .multipliedBy(100)\r\n      .toFixed(4)\r\n  })\r\n\r\n  // Actions\r\n  const fetchVaultData = async () => {\r\n    const walletStore = useWalletStore()\r\n    const appStore = useAppStore()\r\n\r\n    if (!walletStore.isConnected) return\r\n\r\n    try {\r\n      isLoading.value = true\r\n\r\n      const contract = await contractService.getSavingsVaultContract()\r\n      if (!contract) throw new Error('Contract not available')\r\n\r\n      // Fetch vault data\r\n      const [vaultTotalAssets, vaultTotalSupply, mmfTotalSupply, nav, maxWithdraw, currentAPY, incrementAmount] = await Promise.all([\r\n        contract.totalAssets(),\r\n        contract.totalSupply(),\r\n        contract.totalMMFSupply(),\r\n        contract.getNAV_sWRMB(),\r\n        contract.maxWithdraw(walletStore.address),\r\n        contract.getCurrentYearNAVSummary(),\r\n        contract.getUserIncrementAmount(walletStore.address),\r\n      ])\r\n\r\n      totalAssets.value = formatUnits(vaultTotalAssets.toString(), 18)\r\n      totalSupply.value = formatUnits(vaultTotalSupply.toString(), 18)\r\n      totalMMFSupply.value = formatUnits(mmfTotalSupply.toString(), 18)\r\n      userAssetValue.value = formatUnits(maxWithdraw.toString(), 18)\r\n      userIncrementAmount.value = formatUnits(incrementAmount.toString(), 18)\r\n\r\n      currentNAV.value = formatUnits(nav, 18)\r\n      apy.value = new BigNumber(formatUnits(currentAPY.lastIncrease, 16)).multipliedBy(365).toString()\r\n      const sWRMB_external_shares = new BigNumber(totalSupply.value).gt(0) ? totalSupply.value : '1'\r\n      const B_Total_APY = new BigNumber(apy.value).multipliedBy(totalMMFSupply.value).dividedBy(sWRMB_external_shares);\r\n      dynamicAPY.value = B_Total_APY.gt(0) ? B_Total_APY.toString() : '0';\r\n      const baseWRMB = new BigNumber(apy.value).multipliedBy(totalMMFSupply.value);\r\n      dynamicWRMB.value = baseWRMB.dividedBy(100).toString();\r\n\r\n      // Fetch WRMB price (placeholder - in real implementation, this would come from an oracle or API)\r\n      await fetchWRMBPrice()\r\n\r\n      // Fetch user balances if connected\r\n      if (walletStore.address) {\r\n        await fetchUserBalances()\r\n      }\r\n    } catch (error: any) {\r\n      console.error('Failed to fetch vault data:', error)\r\n      // appStore.addNotification({\r\n      //   type: 'error',\r\n      //   title: 'Data Fetch Failed',\r\n      //   message: error.message || 'Failed to fetch vault data'\r\n      // })\r\n    } finally {\r\n      isLoading.value = false\r\n    }\r\n  }\r\n\r\n  const fetchUserBalances = async () => {\r\n    const walletStore = useWalletStore()\r\n    if (!walletStore.address) return\r\n\r\n    try {\r\n      const [savingsContract, wrmbContract] = await Promise.all([\r\n        contractService.getSavingsVaultContract(),\r\n        contractService.getWRMBContract()\r\n      ])\r\n\r\n      if (!savingsContract || !wrmbContract) return\r\n\r\n      const [sWRMBBalance, wrmbUserBalance] = await Promise.all([\r\n        savingsContract.balanceOf(walletStore.address),\r\n        wrmbContract.balanceOf(walletStore.address)\r\n      ])\r\n\r\n      userBalance.value = formatUnits(sWRMBBalance, 18)\r\n      wrmbBalance.value = formatUnits(wrmbUserBalance, 18)\r\n    } catch (error) {\r\n      console.error('Failed to fetch user balances:', error)\r\n    }\r\n  }\r\n\r\n  const previewDeposit = async (amount: string) => {\r\n    if (!amount || amount === '0') return { shares: '0', fee: '0' }\r\n\r\n    try {\r\n      const contract = await contractService.getSavingsVaultContract()\r\n      if (!contract) throw new Error('Contract not available')\r\n\r\n      const amountWei = parseUnits(amount, 18)\r\n      const shares = await contract.previewDeposit(amountWei)\r\n\r\n      return {\r\n        shares: formatUnits(shares, 18),\r\n        fee: '0' // No fee for deposits in this implementation\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to preview deposit:', error)\r\n      return { shares: '0', fee: '0' }\r\n    }\r\n  }\r\n\r\n  const previewWithdraw = async (amount: string) => {\r\n    if (!amount || amount === '0') return { shares: '0', assets: '0', fee: '0' }\r\n\r\n    try {\r\n      const contract = await contractService.getSavingsVaultContract()\r\n      if (!contract) throw new Error('Contract not available')\r\n\r\n      const assetsWei = parseUnits(amount, 18)\r\n      const shares = await contract.previewWithdrawOfFee(assetsWei)\r\n\r\n      return {\r\n        shares: formatUnits(shares[0], 18),\r\n        assets: formatUnits(shares[1], 18),\r\n        fee: formatUnits(shares[2], 18)\r\n      }\r\n    } catch (error) {\r\n      console.error('Failed to preview withdraw:', error)\r\n      return { shares: '0', assets: '0', fee: '0' }\r\n    }\r\n  }\r\n\r\n  const fetchWRMBPrice = async () => {\r\n    try {\r\n      // In a real implementation, this would fetch from an oracle or price API\r\n      // For now, we'll use a mock price with some variation\r\n      const basePrice = 0.14\r\n      const variation = (Math.random() - 0.5) * 0.02 // Â±1% variation\r\n      currentPrice.value = (basePrice + variation).toFixed(4)\r\n    } catch (error) {\r\n      console.error('Failed to fetch WRMB price:', error)\r\n      // Fallback to default price\r\n      currentPrice.value = '0.14'\r\n    }\r\n  }\r\n\r\n  // Auto-refresh data\r\n  let refreshInterval: NodeJS.Timeout | null = null\r\n\r\n  const startAutoRefresh = () => {\r\n    if (refreshInterval) {\r\n      clearInterval(refreshInterval)\r\n    }\r\n\r\n    refreshInterval = setInterval(() => {\r\n      if (Date.now() - lastUpdateTime.value > 12000) { // 12 seconds\r\n        fetchVaultData()\r\n      }\r\n    }, 12000)\r\n  }\r\n\r\n  const stopAutoRefresh = () => {\r\n    if (refreshInterval) {\r\n      clearInterval(refreshInterval)\r\n      refreshInterval = null\r\n    }\r\n  }\r\n\r\n  return {\r\n    // State\r\n    userBalance,\r\n    wrmbBalance,\r\n    totalAssets,\r\n    currentNAV,\r\n    currentPrice,\r\n    totalSupply,\r\n    apy,\r\n    dynamicAPY,\r\n    dynamicWRMB,\r\n    userIncrementAmount,\r\n    isLoading,\r\n    depositAmount,\r\n    withdrawAmount,\r\n    isDepositing,\r\n    isWithdrawing,\r\n    historicalNAV,\r\n\r\n    // Getters\r\n    userBalanceFormatted,\r\n    wrmbBalanceFormatted,\r\n    totalAssetsFormatted,\r\n    userSharePercentage,\r\n    userAssetValue,\r\n\r\n    // Actions\r\n    fetchVaultData,\r\n    fetchUserBalances,\r\n    fetchWRMBPrice,\r\n    previewDeposit,\r\n    previewWithdraw,\r\n    startAutoRefresh,\r\n    stopAutoRefresh,\r\n\r\n    // Computed getters for reactive access\r\n    get depositInProgress() { return isDepositing.value },\r\n    get withdrawInProgress() { return isWithdrawing.value },\r\n    get loading() { return isLoading.value }\r\n  }\r\n})"],"names":["useSavingsStore","defineStore","userBalance","ref","wrmbBalance","totalAssets","currentNAV","currentPrice","totalSupply","totalMMFSupply","apy","dynamicAPY","dynamicWRMB","userAssetValue","userIncrementAmount","isLoading","lastUpdateTime","historicalNAV","depositAmount","withdrawAmount","isDepositing","isWithdrawing","userBalanceFormatted","computed","BigNumber","formatUnits","wrmbBalanceFormatted","totalAssetsFormatted","userSharePercentage","fetchVaultData","walletStore","useWalletStore","useAppStore","contract","contractService","vaultTotalAssets","vaultTotalSupply","mmfTotalSupply","nav","maxWithdraw","currentAPY","incrementAmount","sWRMB_external_shares","B_Total_APY","baseWRMB","fetchWRMBPrice","fetchUserBalances","error","savingsContract","wrmbContract","sWRMBBalance","wrmbUserBalance","previewDeposit","amount","amountWei","parseUnits","shares","previewWithdraw","assetsWei","variation","refreshInterval"],"mappings":"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"}