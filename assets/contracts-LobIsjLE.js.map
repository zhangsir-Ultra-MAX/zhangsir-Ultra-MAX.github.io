{"version":3,"file":"contracts-LobIsjLE.js","sources":["../../src/services/contracts.ts"],"sourcesContent":["import { Contract, Interface } from 'ethers'\r\nimport { useWalletStore } from '../stores/wallet'\r\nimport { CONTRACTS, TOKENS } from '../constants'\r\n\r\n// Get contract addresses based on current chain ID\r\nconst getContractAddresses = (chainId: number) => {\r\n  return {\r\n    SAVINGS_VAULT: CONTRACTS.SAVINGS_VAULT[chainId as keyof typeof CONTRACTS.SAVINGS_VAULT] || '',\r\n    WRAP_MANAGER: CONTRACTS.WRAP_MANAGER[chainId as keyof typeof CONTRACTS.WRAP_MANAGER] || '',\r\n    BOND_POOL: CONTRACTS.BOND_POOL[chainId as keyof typeof CONTRACTS.BOND_POOL] || '',\r\n    STAKING_VAULT: CONTRACTS.STAKING_VAULT[chainId as keyof typeof CONTRACTS.STAKING_VAULT] || '',\r\n    FARM_VAULT: CONTRACTS.FARM_VAULT[chainId as keyof typeof CONTRACTS.FARM_VAULT] || '',\r\n    WRMB: TOKENS.WRMB.addresses[chainId as keyof typeof TOKENS.WRMB.addresses] || '',\r\n    SRMB: TOKENS.sRMB.addresses[chainId as keyof typeof TOKENS.sRMB.addresses] || '',\r\n    CINA: TOKENS.CINA.addresses[chainId as keyof typeof TOKENS.CINA.addresses] || '',\r\n    USDT: TOKENS.USDT.addresses[chainId as keyof typeof TOKENS.USDT.addresses] || ''\r\n  }\r\n}\r\n\r\n// Contract ABIs - simplified versions for the main functions\r\nconst SAVINGS_VAULT_ABI = [\r\n  'function totalAssets() view returns (uint256)',\r\n  'function totalSupply() view returns (uint256)',\r\n  'function balanceOf(address) view returns (uint256)',\r\n  'function allowance(address, address) view returns (uint256)',\r\n  'function approve(address, uint256) returns (bool)',\r\n  'function getNAV_sWRMB() view returns (uint256)',\r\n  'function totalMMFSupply() view returns (uint256)',\r\n  'function previewDeposit(uint256) view returns (uint256)',\r\n  'function previewRedeem(uint256) view returns (uint256)',\r\n  'function previewMint(uint256) view returns (uint256)',\r\n  'function previewWithdraw(uint256) view returns (uint256)',\r\n  'function getIncrementAmount() view returns (uint256)',\r\n  'function getUserIncrementAmount(address) view returns (uint256)',\r\n  'function previewWithdrawOfFee(uint256) view returns (uint256, uint256, uint256)',\r\n  'function maxWithdraw(address) view returns (uint256)',\r\n  'function getCurrentYearNAVSummary() view returns (uint256 totalIncrease, uint256 averageIncrease, uint256 maxIncrease, uint256 minIncrease, uint256 recordCount, uint256 firstIncrease, uint256 lastIncrease)',\r\n  'function deposit(uint256, address) returns (uint256)',\r\n  'function redeem(uint256, address, address) returns (uint256)',\r\n  'function withdraw(uint256, address, address) returns (uint256)',\r\n  'function asset() view returns (address)',\r\n  'event Deposit(address indexed caller, address indexed owner, uint256 assets, uint256 shares)',\r\n  'event Withdraw(address indexed caller, address indexed receiver, address indexed owner, uint256 assets, uint256 shares)',\r\n  'event WRMBMintedOnIncrease(uint256 amount, uint256 oldNAV, uint256 newNAV)'\r\n]\r\n\r\nconst WRAP_MANAGER_ABI = [\r\n  'function wrap(uint256) returns (uint256, uint256)',\r\n  'function unwrap(uint256 sRMBAmount) returns (uint256 sWRMBBurned, uint256 sRMBReceived)',\r\n  'function previewWrap(address, uint256) view returns (uint256, uint256, uint256, uint256, uint256)',\r\n  'function previewUnwrap(address, uint256) view returns (uint256, uint256, uint256, uint256, uint256)',\r\n  'function getConfiguration() view returns (address, address, address, uint256, uint256, uint256, uint256, uint256, uint256)',\r\n  'function minWrapAmount() view returns (uint256)',\r\n  'function maxWrapAmount() view returns (uint256)',\r\n  'function minUnwrapAmount() view returns (uint256)',\r\n  'function maxUnwrapAmount() view returns (uint256)',\r\n  'function wrapFee() view returns (uint256)',\r\n  'function unwrapFee() view returns (uint256)',\r\n  'function getSRMBLiquidity() view returns (uint256)',\r\n  'function wrapAndUnwrapInterval() view returns (uint256)',\r\n  'function totalReserveTransferred() view returns (uint256)',\r\n  'function getUserUnwrappableAmount(address) view returns (uint256)',\r\n  'function getUserWrapStats(address) view returns (uint256, uint256, uint256)',\r\n  'function userWrappedAmount(address) view returns (uint256)',\r\n  'function userUnwrappedAmount(address) view returns (uint256)',\r\n  'event Wrapped(address indexed user, uint256 sRMBAmount, uint256 sWRMBReceived, uint256 wrmBMinted, uint256 fee)',\r\n  'event Unwrapped(address indexed user, uint256 sWRMBAmount, uint256 sRMBReceived, uint256 wrmBBurned, uint256 fee)'\r\n]\r\n\r\nconst BOND_POOL_ABI = [\r\n  'function subscribeBond(uint256)',\r\n  'function matureBond(uint256)',\r\n  'function getUserBonds(address) view returns (uint256[], tuple(uint256 principal, uint256 wrmbAmount, uint256 subscribeTime, uint256 maturityTime, uint256 interestRate, bool isActive, bool isMatured)[])',\r\n  'function previewSubscription(uint256) view returns (uint256, uint256, uint256)',\r\n  'function getPoolStats() view returns (uint256, uint256, uint256)',\r\n  'function calculateCompoundInterest(uint256, uint256, uint256, uint256) pure returns (uint256)',\r\n  'function poolConfig() view returns (tuple(uint256 minSubscription, uint256 maxSubscription, uint256 bondDuration, uint256 interestRate, uint256 maxPoolSize, bool subscriptionOpen))',\r\n  'function bonds(uint256) view returns (tuple(uint256 principal, uint256 wrmbAmount, uint256 subscribeTime, uint256 maturityTime, uint256 interestRate, bool isActive, bool isMatured))',\r\n  'function userTotalPrincipal(address) view returns (uint256)',\r\n  'event BondSubscribed(address indexed user, uint256 indexed bondId, uint256 usdtAmount, uint256 wrmbAmount, uint256 maturityTime)',\r\n  'event BondMatured(address indexed user, uint256 indexed bondId, uint256 principalAmount, uint256 interestAmount, uint256 totalAmount)'\r\n]\r\n\r\nconst STAKING_VAULT_ABI = [\r\n  // ERC4626 标准方法\r\n  'function totalAssets() view returns (uint256)',\r\n  'function totalSupply() view returns (uint256)',\r\n  'function balanceOf(address) view returns (uint256)',\r\n  'function maxWithdraw(address) view returns (uint256)',\r\n  'function deposit(uint256 assets, address receiver) returns (uint256 shares)',\r\n  'function withdraw(uint256 assets, address receiver, address owner) returns (uint256 shares)',\r\n  'function mint(uint256 shares, address receiver) returns (uint256 assets)',\r\n  'function redeem(uint256 shares, address receiver, address owner) returns (uint256 assets)',\r\n  'function previewDeposit(uint256 assets) view returns (uint256)',\r\n  'function previewWithdraw(uint256 assets) view returns (uint256)',\r\n  'function previewMint(uint256 shares) view returns (uint256)',\r\n  'function previewRedeem(uint256 shares) view returns (uint256)',\r\n  \r\n  // 质押相关查询方法\r\n  'function getNAV_CINA() view returns (uint256)',\r\n  'function minStakeAmount() view returns (uint256)',\r\n  'function lastDayRewardAmount() view returns (uint256)',\r\n  'function getIncrementAmount() view returns (uint256)',\r\n  'function getUserIncrementAmount(address) view returns (uint256)',\r\n\r\n  // 事件\r\n  'event Staked(address indexed user, uint256 amount, uint256 shares)',\r\n  'event Unstaked(address indexed user, uint256 amount, uint256 shares, uint256 penalty)',\r\n  'event RewardClaimed(address indexed user, uint256 amount)',\r\n  'event EmergencyWithdraw(address indexed user, uint256 amount)'\r\n]\r\n\r\nconst FARM_VAULT_ABI = [\r\n  'function totalSupply() external view returns (uint256)',\r\n  'function balanceOf(address account) external view returns (uint256)',\r\n  'function earned(address account) external view returns (uint256)',\r\n  'function getRewardForDuration() external view returns (uint256)',\r\n  'function lastTimeRewardApplicable() external view returns (uint256)',\r\n  'function getRemainingTime() external view returns (uint256)',\r\n  'function rewardRate() external view returns (uint256)',\r\n  \r\n  'function deposit(uint256 amount) external',\r\n  'function withdraw(uint256 amount, bool isClaim) external',\r\n  'function getReward() external',\r\n]\r\n\r\nconst ERC20_ABI = [\r\n  'function balanceOf(address) view returns (uint256)',\r\n  'function allowance(address, address) view returns (uint256)',\r\n  'function approve(address, uint256) returns (bool)',\r\n  'function transfer(address, uint256) returns (bool)',\r\n  'function transferFrom(address, address, uint256) returns (bool)',\r\n  'function decimals() view returns (uint8)',\r\n  'function symbol() view returns (string)',\r\n  'function name() view returns (string)',\r\n  'function totalSupply() view returns (uint256)',\r\n  'event Transfer(address indexed from, address indexed to, uint256 value)',\r\n  'event Approval(address indexed owner, address indexed spender, uint256 value)'\r\n]\r\n\r\nclass ContractService {\r\n  private contracts: Map<string, Contract> = new Map()\r\n  \r\n  private getContract(address: string, abi: string[], withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    \r\n    if (!walletStore.provider) {\r\n      console.warn('Provider not available')\r\n      return null\r\n    }\r\n    \r\n    if (!address || address === '') {\r\n      console.warn('Contract address not available for current network')\r\n      return null\r\n    }\r\n    \r\n    const key = `${address}_${walletStore.chainId}_${withSigner ? 'signer' : 'provider'}_${abi.length}`\r\n    \r\n    if (this.contracts.has(key)) {\r\n      return this.contracts.get(key)!\r\n    }\r\n    \r\n    try {\r\n      const providerOrSigner = withSigner ? walletStore.signer : walletStore.provider\r\n      if (!providerOrSigner) {\r\n        console.warn('Provider or signer not available')\r\n        return null\r\n      }\r\n      \r\n      const contract = new Contract(address, abi, providerOrSigner)\r\n      this.contracts.set(key, contract)\r\n      return contract\r\n    } catch (error) {\r\n      console.error('Failed to create contract:', error)\r\n      return null\r\n    }\r\n  }\r\n  \r\n  // Savings Vault Contract\r\n  getSavingsVaultContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.SAVINGS_VAULT, SAVINGS_VAULT_ABI, withSigner)\r\n  }\r\n  \r\n  // Wrap Manager Contract\r\n  getWrapManagerContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.WRAP_MANAGER, WRAP_MANAGER_ABI, withSigner)\r\n  }\r\n  \r\n  // Bond Pool Contract\r\n  getBondPoolContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.BOND_POOL, BOND_POOL_ABI, withSigner)\r\n  }\r\n  \r\n  // Token Contracts\r\n  getWRMBContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.WRMB, ERC20_ABI, withSigner)\r\n  }\r\n  \r\n  getSRMBContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.SRMB, ERC20_ABI, withSigner)\r\n  }\r\n  \r\n  getUSDTContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.USDT, ERC20_ABI, withSigner)\r\n  }\r\n  \r\n  getCINAContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.CINA, ERC20_ABI, withSigner)\r\n  }\r\n  \r\n  // Staking Vault Contract\r\n  getStakingVaultContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.STAKING_VAULT, STAKING_VAULT_ABI, withSigner)\r\n  }\r\n\r\n  // Farm Vault Contract\r\n  getFarmVaultContract(withSigner = false): Contract | null {\r\n    const walletStore = useWalletStore()\r\n    const addresses = getContractAddresses(walletStore.chainId)\r\n    return this.getContract(addresses.FARM_VAULT, FARM_VAULT_ABI, withSigner)\r\n  }\r\n  \r\n  // Generic ERC20 contract\r\n  getERC20Contract(address: string, withSigner = false): Contract | null {\r\n    return this.getContract(address, ERC20_ABI, withSigner)\r\n  }\r\n  \r\n  // Clear cached contracts (useful when switching accounts/networks)\r\n  clearCache(): void {\r\n    this.contracts.clear()\r\n  }\r\n  \r\n  // Get contract addresses for current network\r\n  getAddresses() {\r\n    const walletStore = useWalletStore()\r\n    return getContractAddresses(walletStore.chainId)\r\n  }\r\n  \r\n  // Get contract addresses for specific chain ID\r\n  getAddressesForChain(chainId: number) {\r\n    return getContractAddresses(chainId)\r\n  }\r\n  \r\n  // Utility function to check if address is valid\r\n  isValidAddress(address: string): boolean {\r\n    return /^0x[a-fA-F0-9]{40}$/.test(address)\r\n  }\r\n  \r\n  // Get contract interface for event parsing\r\n  getSavingsVaultInterface(): Interface {\r\n    return new Interface(SAVINGS_VAULT_ABI)\r\n  }\r\n  \r\n  getWrapManagerInterface(): Interface {\r\n    return new Interface(WRAP_MANAGER_ABI)\r\n  }\r\n  \r\n  getBondPoolInterface(): Interface {\r\n    return new Interface(BOND_POOL_ABI)\r\n  }\r\n  \r\n  getERC20Interface(): Interface {\r\n    return new Interface(ERC20_ABI)\r\n  }\r\n  \r\n  getStakingVaultInterface(): Interface {\r\n    return new Interface(STAKING_VAULT_ABI)\r\n  }\r\n  \r\n  getFarmVaultInterface(): Interface {\r\n    return new Interface(FARM_VAULT_ABI)\r\n  }\r\n}\r\n\r\nexport const contractService = new ContractService()\r\nexport { getContractAddresses }"],"names":["getContractAddresses","chainId","CONTRACTS","TOKENS","SAVINGS_VAULT_ABI","WRAP_MANAGER_ABI","BOND_POOL_ABI","STAKING_VAULT_ABI","FARM_VAULT_ABI","ERC20_ABI","ContractService","address","abi","withSigner","walletStore","useWalletStore","key","providerOrSigner","contract","Contract","error","addresses","Interface","contractService"],"mappings":"uEAKA,MAAMA,EAAwBC,IACrB,CACL,cAAeC,EAAU,cAAcD,CAA+C,GAAK,GAC3F,aAAcC,EAAU,aAAaD,CAA8C,GAAK,GACxF,UAAWC,EAAU,UAAUD,CAA2C,GAAK,GAC/E,cAAeC,EAAU,cAAcD,CAA+C,GAAK,GAC3F,WAAYC,EAAU,WAAWD,CAA4C,GAAK,GAClF,KAAME,EAAO,KAAK,UAAUF,CAA6C,GAAK,GAC9E,KAAME,EAAO,KAAK,UAAUF,CAA6C,GAAK,GAC9E,KAAME,EAAO,KAAK,UAAUF,CAA6C,GAAK,GAC9E,KAAME,EAAO,KAAK,UAAUF,CAA6C,GAAK,EAChF,GAIIG,EAAoB,CACxB,gDACA,gDACA,qDACA,8DACA,oDACA,iDACA,mDACA,0DACA,yDACA,uDACA,2DACA,uDACA,kEACA,kFACA,uDACA,gNACA,uDACA,+DACA,iEACA,0CACA,+FACA,0HACA,4EACF,EAEMC,EAAmB,CACvB,oDACA,0FACA,oGACA,sGACA,6HACA,kDACA,kDACA,oDACA,oDACA,4CACA,8CACA,qDACA,0DACA,4DACA,oEACA,8EACA,6DACA,+DACA,kHACA,mHACF,EAEMC,EAAgB,CACpB,kCACA,+BACA,4MACA,iFACA,mEACA,gGACA,uLACA,wLACA,8DACA,mIACA,uIACF,EAEMC,EAAoB,CAExB,gDACA,gDACA,qDACA,uDACA,8EACA,8FACA,2EACA,4FACA,iEACA,kEACA,8DACA,gEAGA,gDACA,mDACA,wDACA,uDACA,kEAGA,qEACA,wFACA,4DACA,+DACF,EAEMC,EAAiB,CACrB,yDACA,sEACA,mEACA,kEACA,sEACA,8DACA,wDAEA,4CACA,2DACA,+BACF,EAEMC,EAAY,CAChB,qDACA,8DACA,oDACA,qDACA,kEACA,2CACA,0CACA,wCACA,gDACA,0EACA,+EACF,EAEA,MAAMC,CAAgB,CACZ,cAAuC,IAEvC,YAAYC,EAAiBC,EAAeC,EAAa,GAAwB,CACvF,MAAMC,EAAcC,EAAe,EAE/B,GAAA,CAACD,EAAY,SACf,eAAQ,KAAK,wBAAwB,EAC9B,KAGL,GAAA,CAACH,GAAWA,IA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"}