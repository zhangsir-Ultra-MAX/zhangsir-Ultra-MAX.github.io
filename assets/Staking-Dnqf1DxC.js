import{R as me,r as l,a as K,I as C,O as W,d as ke,u as ge,c as q,o as fe,w as ee,b as we,e as k,f as a,g as h,t as r,h as o,ag as _e,L as Ce,x as U,G as L,y as ae,F as te,M as ye,j as $,E as Ae,aj as be,N as Se,T as Ie,P as se,J as x,_ as Ne}from"./index-EBZBD7IP.js";import{A as Fe}from"./AnimatedNumber-DMAocXSA.js";import{u as Re,P as Ve}from"./usePullToRefresh-BJGuk06y.js";import{F as ne}from"./FormattedInput-DGcZDhfq.js";import{c as V}from"./contracts-LobIsjLE.js";import{f as A,b as oe,c as le}from"./format-DgO97vlP.js";import{d as ie}from"./debounce-CLGozXK5.js";/* empty css                 */const Te=me("staking",()=>{const E=l("0"),i=l("0"),u=l("0"),s=l("0"),g=l("0"),d=l("0"),p=l("0.01"),y=l("1.0"),b=l("0"),T=l("0"),N=l(!1),_=l(0),m=async()=>{const c=K();if(c.isConnected)try{N.value=!0;const n=V.getStakingVaultContract();if(!n){console.warn("Staking contract not available, using mock data"),E.value="1250000.5678",i.value="1200000.0000",d.value="12.5",y.value="1.025",p.value="1.0",b.value="0.0005",c.address&&await S();return}const[f,I,B,P,G,H]=await Promise.all([n.totalSupply().catch(()=>"0"),n.getNAV_CINA().catch(()=>"1000000000000000000"),n.minStakeAmount().catch(()=>"1000000000000000000"),n.getUserIncrementAmount(c.address).catch(()=>"0"),n.maxWithdraw(c.address).catch(()=>"0"),n.lastDayRewardAmount().catch(()=>"0")]);i.value=C(f,18),y.value=C(I,18),p.value=C(B,18),b.value=C(P,18),E.value=C(G,18);const M=parseFloat(C(H,18)),z=parseFloat(i.value)>0?parseFloat(i.value):1;M>0?d.value=(M/z*365*100).toFixed(2):d.value="0",c.address&&await S(),_.value=Date.now()}catch(n){console.error("Failed to fetch staking data:",n)}finally{N.value=!1}},S=async()=>{const c=K();if(c.address)try{const n=V.getStakingVaultContract(),f=V.getCINAContract();if(!n||!f){console.warn("Contracts not available, using mock user data"),u.value="500.123456",g.value="250.789012";return}const[I,B,P]=await Promise.all([f.balanceOf(c.address).catch(()=>"0"),n.balanceOf(c.address).catch(()=>"0"),n.maxWithdraw(c.address).catch(()=>"0")]);u.value=C(I,18),g.value=C(P,18),s.value=C(B,18)}catch(n){console.error("Failed to fetch user staking data:",n)}},D=async c=>{if(!c||c==="0")return{shares:"0",fee:"0"};try{const n=await V.getStakingVaultContract();if(!n)throw new Error("Contract not available");const f=W(c,18),I=await n.previewDeposit(f);return{shares:C(I,18),fee:"0"}}catch(n){return console.error("Failed to preview deposit:",n),{shares:"0",fee:"0"}}},O=async c=>{if(!c||c==="0")return{shares:"0",assets:"0",fee:"0"};try{const n=await V.getStakingVaultContract();if(!n)throw new Error("Contract not available");const f=W(c,18),I=await n.previewWithdraw(f);return{shares:C(I,18)}}catch(n){return console.error("Failed to preview withdraw:",n),{shares:"0",assets:"0",fee:"0"}}};let F=null;return{yourStaked:E,totalSupply:i,cinaBalance:u,stCINABalance:s,stakedAmount:g,currentAPY:d,navCina:y,minStakeAmount:p,incrementAmount:b,userIncrementAmount:T,isLoading:N,fetchStakingData:m,fetchUserStakingData:S,startAutoRefresh:()=>{F&&clearInterval(F),F=setInterval(()=>{Date.now()-_.value>15e3&&m()},15e3)},stopAutoRefresh:()=>{F&&(clearInterval(F),F=null)},previewDeposit:D,previewWithdraw:O,get loading(){return N.value}}}),De={class:"staking"},$e={class:"staking-content"},xe={class:"staking-overview"},Be={class:"section-title"},Pe={class:"overview-grid"},Ue={class:"overview-card"},We={class:"card-header"},Ee={class:"card-title"},Me={class:"card-subtitle"},ze={class:"card-value"},qe={class:"action-section"},Le={class:"tab-content"},Oe={class:"action-form"},je={class:"input-section"},Ye={class:"input-group"},Ge={class:"quick-amounts"},He={key:0,class:"warning-info"},Je={key:0,class:"preview-section"},Ke={class:"preview-title"},Qe={class:"preview-details"},Xe={class:"preview-row"},Ze={class:"preview-value"},ea={class:"preview-row exchange-rate"},aa={class:"preview-value"},ta={class:"tab-content"},sa={class:"action-form"},na={class:"input-section"},oa={class:"input-group"},la={class:"quick-amounts"};const ia={key:0,class:"preview-section"},ra={class:"preview-title"},ca={class:"preview-details"},ua={class:"preview-row"},da={class:"preview-value"},va={class:"preview-row exchange-rate"},pa={class:"preview-value"},ha=ke({__name:"Staking",setup(E){const{t:i}=ge(),u=K(),s=Te(),g=l("stake"),d=l(""),p=l(""),y=l({shares:"",fee:"0"}),b=l({shares:""}),T=l(!1),N=l(""),_=l(0),m=l("pending"),S=l(""),D=l(""),O=l([{label:i("transaction.approve"),description:i("transaction.approveDescription")},{label:i("transaction.confirm"),description:i("transaction.confirmDescription")},{label:i("transaction.complete"),description:i("transaction.completeDescription")}]),F=q(()=>{const e=[];return g.value==="stake"&&d.value?e.push({label:i("pay"),value:`-${A(d.value,6)} CINA`,highlight:!0,type:"debit"},{label:i("receive"),value:`+${A(y.value?.shares||"0",6)} stCINA`,type:"credit"}):g.value==="unstake"&&p.value&&e.push({label:i("pay"),value:`-${A(b.value?.shares||"0",6)} stCINA`,type:"debit"},{label:i("receive"),value:`+${A(p.value,6)} CINA`,highlight:!0,type:"credit"}),e}),j=q(()=>{const e=parseFloat(d.value);return e>0&&e<=parseFloat(s.cinaBalance)&&e>=parseFloat(s.minStakeAmount)}),Y=q(()=>{const e=parseFloat(p.value);return e>0&&e<=parseFloat(s.stakedAmount)}),c=q(()=>{const e=parseFloat(d.value);return e>0&&e<parseFloat(s.minStakeAmount)}),n=ie(async e=>{if(e&&parseFloat(e)>0)try{y.value=await s.previewDeposit(e),console.log(y.value)}catch(t){console.error("Failed to preview stake:",t)}else y.value={shares:"",fee:"0"}},500),f=ie(async e=>{if(e&&parseFloat(e)>0)try{b.value=await s.previewWithdraw(e)}catch(t){console.error("Failed to preview unstake:",t)}else b.value={shares:""}},500),I=e=>{const t=e.replace(/[^0-9.]/g,"");d.value=t,n(t)},B=e=>{const t=e.replace(/[^0-9.]/g,"");p.value=t,f(t)},P=e=>{const t=le(s.cinaBalance,e);d.value=t,n(t)},G=()=>{d.value=s.cinaBalance,n(s.cinaBalance)},H=e=>{const t=le(s.stakedAmount,e);p.value=t,f(t)},M=()=>{p.value=s.stakedAmount,f(s.stakedAmount)},z=async()=>{if(!(!j.value||!u.isConnected)){N.value=i("staking.stakeTransaction"),T.value=!0,_.value=0,m.value="pending";try{const e=W(d.value,18),t=V.getStakingVaultContract(!0),w=V.getCINAContract(!0);if(!t||!w)throw new Error("Contract not available");const R=await t.getAddress();await w.allowance(u.address,R)<e&&(m.value="loading",await(await w.approve(R,e)).wait()),_.value=1,m.value="loading";const v=await(await t.deposit(e,u.address)).wait();S.value=v.hash,_.value=2,m.value="success",d.value="",await s.fetchStakingData(),_.value=3,se.success(i("staking.stakeSuccess"))}catch(e){m.value="error",D.value=e.message||i("staking.stakeFailed"),console.error("Stake failed:",e)}}},Q=async()=>{if(!(!Y.value||!u.isConnected)){N.value=i("staking.unstakeTransaction"),T.value=!0,_.value=1,m.value="loading";try{const e=W(p.value,18),t=V.getStakingVaultContract(!0);if(!t)throw new Error("Contract not available");if(p.value==s.stakedAmount){const R=await(await t.redeem(W(s.stCINABalance,18),u.address,u.address)).wait();S.value=R.hash}else{const R=await(await t.withdraw(e,u.address,u.address)).wait();S.value=R.hash}_.value=2,m.value="success",p.value="",await s.fetchStakingData(),_.value=3,se.success(i("staking.unstakeSuccess"))}catch(e){m.value="error",D.value=e.message||i("staking.unstakeFailed"),console.error("Unstake failed:",e)}}},re=async()=>{u.isConnected&&await s.fetchStakingData()},{isRefreshing:ce,pullDistance:ue,isPulling:de,canRefresh:ve}=Re({onRefresh:re,enabled:!0});fe(async()=>{u.isConnected&&(await s.fetchStakingData(),await s.startAutoRefresh())}),ee(()=>u.isConnected,async e=>{e&&await s.fetchStakingData()}),ee(g,e=>{d.value="",p.value=""});const pe=()=>{T.value=!1,S.value="",D.value=""},he=()=>{g.value==="stake"?z():Q()};return(e,t)=>{const w=ye,R=Ae,J=Ce,X=Se;return x(),we(Ve,{"is-pulling":o(de),"is-refreshing":o(ce),"pull-distance":o(ue),"can-refresh":o(ve)},{default:k(()=>[a("div",De,[a("div",$e,[a("div",xe,[a("h2",Be,r(e.$t("staking.overview")),1),a("div",Pe,[a("div",Ue,[a("div",We,[a("h3",Ee,r(e.$t("staking.yourStaked")),1),a("div",Me,r(e.$t("staking.apy"))+" "+r(o(A)(o(s).currentAPY))+"% ",1)]),a("div",ze,[t[4]||(t[4]=a("img",{src:_e,alt:"",class:"token-icon"},null,-1)),h(Fe,{class:"animated-number",value:o(s).yourStaked,decimals:8,"auto-increment":o(u).isConnected&&parseFloat(o(s).yourStaked)>0,"increment-amount":parseFloat(o(s).incrementAmount),"increment-interval":1e3,"cache-key":`yourStaked_${o(u).address}`,"use-cache":!1},null,8,["value","auto-increment","increment-amount","cache-key"])])])])]),a("div",qe,[h(X,{modelValue:g.value,"onUpdate:modelValue":t[2]||(t[2]=v=>g.value=v),class:"staking-tabs"},{default:k(()=>[h(J,{label:e.$t("staking.stakeCINA"),name:"stake"},{default:k(()=>[a("div",Le,[a("div",Oe,[a("div",je,[a("div",Ye,[h(ne,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=v=>d.value=v),placeholder:o(oe)(o(s).cinaBalance,6)+"  available",size:"large",class:"amount-input",decimals:6,"use-abbreviation":!0,"max-decimals":18,onInputChange:I},{suffix:k(()=>t[5]||(t[5]=[a("span",{class:"input-suffix"},"CINA",-1)])),_:1},8,["modelValue","placeholder"])]),a("div",Ge,[(x(),U(te,null,ae([25,50,75],v=>h(w,{key:v,size:"small",onClick:Z=>P(v)},{default:k(()=>[$(r(v)+"% ",1)]),_:2},1032,["onClick"])),64)),h(w,{onClick:G,class:"max-button",size:"small"},{default:k(()=>[$(r(e.$t("common.max")),1)]),_:1})]),c.value?(x(),U("div",He,[h(R,null,{default:k(()=>[h(o(be))]),_:1}),a("span",null,r(e.$t("staking.minStakeWarning",{amount:o(A)(o(s).minStakeAmount)})),1)])):L("",!0)]),y.value?(x(),U("div",Je,[a("h4",Ke,r(e.$t("staking.preview")),1),a("div",Qe,[a("div",Xe,[a("span",null,r(e.$t("staking.youWillReceive")),1),a("span",Ze,r(o(A)(y.value.shares,2))+" stCINA",1)]),a("div",ea,[a("span",null,r(e.$t("staking.exchangeRate")),1),a("span",aa,"1 CINA ≈ "+r(o(A)(1/parseFloat(o(s).navCina),6))+" stCINA",1)])])])):L("",!0),h(w,{type:"primary",size:"large",loading:m.value==="loading"&&g.value==="stake",disabled:!j.value,onClick:z,class:"action-button"},{default:k(()=>[$(r(e.$t("staking.stakeCINA")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["label"]),h(J,{label:e.$t("staking.unstakeCINA"),name:"unstake"},{default:k(()=>[a("div",ta,[a("div",sa,[a("div",na,[a("div",oa,[h(ne,{modelValue:p.value,"onUpdate:modelValue":t[1]||(t[1]=v=>p.value=v),placeholder:o(oe)(o(s).stakedAmount,6)+"  available",size:"large",class:"amount-input",decimals:6,"use-abbreviation":!0,"max-decimals":18,onInputChange:B},{suffix:k(()=>t[6]||(t[6]=[a("span",{class:"input-suffix"},"CINA",-1)])),_:1},8,["modelValue","placeholder"])]),a("div",la,[(x(),U(te,null,ae([25,50,75],v=>h(w,{key:v,size:"small",onClick:Z=>H(v)},{default:k(()=>[$(r(v)+"% ",1)]),_:2},1032,["onClick"])),64)),h(w,{onClick:M,class:"max-button",size:"small"},{default:k(()=>[$(r(e.$t("common.max")),1)]),_:1})]),L("",!0)]),b.value?(x(),U("div",ia,[a("h4",ra,r(e.$t("staking.preview")),1),a("div",ca,[a("div",ua,[a("span",null,r(e.$t("staking.required")),1),a("span",da,r(o(A)(b.value.shares,2))+" stCINA",1)]),a("div",va,[a("span",null,r(e.$t("staking.exchangeRate")),1),a("span",pa,"1 stCINA ≈ "+r(o(A)(o(s).navCina,6))+" CINA",1)])])])):L("",!0),h(w,{type:"primary",size:"large",loading:m.value==="loading"&&g.value==="unstake",disabled:!Y.value,onClick:Q,class:"action-button"},{default:k(()=>[$(r(e.$t("staking.unstakeCINA")),1)]),_:1},8,["loading","disabled"])])])]),_:1},8,["label"])]),_:1},8,["modelValue"])])]),h(Ie,{visible:T.value,"onUpdate:visible":t[3]||(t[3]=v=>T.value=v),title:N.value,steps:O.value,"current-step":_.value,status:m.value,"transaction-details":F.value,"transaction-hash":S.value,"error-message":D.value,onClose:pe,onRetry:he},null,8,["visible","title","steps","current-step","status","transaction-details","transaction-hash","error-message"])])]),_:1},8,["is-pulling","is-refreshing","pull-distance","can-refresh"])}}}),Aa=Ne(ha,[["__scopeId","data-v-1fd19d04"]]);export{Aa as default};
//# sourceMappingURL=Staking-Dnqf1DxC.js.map
